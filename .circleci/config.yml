version: 2.1

orbs:
  slack: circleci/slack@4.12.0
  node: circleci/node@5.2

jobs:
  monitor-errors-in-prod:
    docker:
      - image: cimg/base:stable
    resource_class: small
    working_directory: ~/repo

    steps:
      - checkout  
      - node/install:
          install-yarn: true
          node-version: '16.13'
      - run: node --version
          
      - run: apt-get update && apt-get install -y curl
      - restore_cache:
          keys:
            - v2-dependencies-{{ checksum "package.json" }}
            - v2-dependencies-

      - run: npm ci

      - save_cache:
          paths:
            - ~/.npm
          key: v2-dependencies-{{ checksum "package.json" }}
      - run:
          name: 'Run tests'
          command: npm run test:jest
      - slack/notify:
          channel: alerts
          event: fail
          template: basic_fail_1


workflows:
  test:
    jobs:
      - monitor-errors-in-prod:
          context:
            - notifiers